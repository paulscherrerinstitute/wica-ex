<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8"/>

    <!-- Load the Wica library -->
    <script src="wica/wica.js" type="module"></script>

    <title>SVG Demo</title>

    <style>

        * {
            padding: 0;
            margin: 0;
            border:0;
        }

        html {
            font-family: "Helvetica Neue",sans-serif;
            font-size: 1.8vmin;
            background-color: grey;
            width: 100%;
        }

        body {
            overflow: hidden;
            margin: auto;
            width: 80%;
            height: 80%;
        }

        .hidden {
           display: none;
        }

    </style>

</head>

<body>
    <div class="hidden">

        <!-- HIPA Clock -->
        <div data-wica-channel-name="XHIPA:TIME"  onchange="update_value( event, '$TIME_TEXT' )"></div>

        <!-- GV1, GV2, GV3 Pressure Gauges: Text Values -->
        <div data-wica-channel-name="GV1:IST:2"   onchange="update_value( event, '$GV1_TEXT'  )" data-wica-channel-props='{ "prec" : 12 }'></div>
        <div data-wica-channel-name="GV2:IST:2"   onchange="update_value( event, '$GV2_TEXT'  )" data-wica-channel-props='{ "prec" : 12 }'></div>
        <div data-wica-channel-name="GV3:IST:2"   onchange="update_value( event, '$GV3_TEXT'  )" data-wica-channel-props='{ "prec" : 12 }'></div>

        <!-- VVD1, VVD2 Valves: Text Values -->
        <div data-wica-channel-name="VVD1:SV:2"   onchange="update_value( event, '$VVD1_VALVE_TEXT'  )"></div>
        <div data-wica-channel-name="VVD2:SV:2"   onchange="update_value( event, '$VVD2_VALVE_TEXT'  )"></div>

        <!-- VVD1, VVD2 Valves: Symbol Colors -->
        <div data-wica-channel-name="VVD1:SV:2"   onchange="update_color( event, '$VVD1_VALVE_SYMBOL', 'SV_OPEN', 'SV_CLOSED' )"></div>
        <div data-wica-channel-name="VVD2:SV:2"   onchange="update_color( event, '$VVD2_VALVE_SYMBOL', 'SV_OPEN', 'SV_CLOSED' )"></div>

        <!-- PV1 Section: Text Values -->
        <div data-wica-channel-name="PV1:TURBO:2" onchange="update_value( event, '$PV1_TURBO_TEXT' )"></div>
        <div data-wica-channel-name="PV1:PV:2"    onchange="update_value( event, '$PV1_VALVE_TEXT' )"></div>
        <div data-wica-channel-name="PV1:CPUM:2"  onchange="update_value( event, '$PV1_PUMP_TEXT'  )"></div>

        <!-- PV1 Section: Symbol Colors -->
        <div data-wica-channel-name="PV1:TURBO:2" onchange="update_color( event, '$PV1_TURBO_SYMBOL', 'TURBO_eingeschaltet', 'TURBO_ausgeschaltet' )"></div>
        <div data-wica-channel-name="PV1:PV:2"    onchange="update_color( event, '$PV1_VALVE_SYMBOL', 'PV_offen', 'PV_geschlossen' )"></div>
        <div data-wica-channel-name="PV1:CPUM:2"  onchange="update_color( event, '$PV1_PUMP_SYMBOL',  'EIN', 'AUS' )"></div>

        <!-- PV2 Beamline Section: Text Values -->
        <div data-wica-channel-name="PV2:TURBO:2" onchange="update_value( event, '$PV2_TURBO_TEXT' )"></div>
        <div data-wica-channel-name="PV2:PV:2"    onchange="update_value( event, '$PV2_VALVE_TEXT' )"></div>
        <div data-wica-channel-name="PV2:CPUM:2"  onchange="update_value( event, '$PV2_PUMP_TEXT'  )"></div>

        <!-- PV2 Beamline Section: Symbol Colors -->
        <div data-wica-channel-name="PV2:TURBO:2" onchange="update_color( event, '$PV2_TURBO_SYMBOL', 'TURBO_eingeschaltet', 'TURBO_ausgeschaltet' )"></div>
        <div data-wica-channel-name="PV2:PV:2"    onchange="update_color( event, '$PV2_VALVE_SYMBOL', 'PV_offen', 'PV_geschlossen' )"></div>
        <div data-wica-channel-name="PV2:CPUM:2"  onchange="update_color( event, '$PV2_PUMP_SYMBOL',  'EIN', 'AUS' )"></div>

        <!-- Dome Cooling Info Box: Text Values -->
        <div data-wica-channel-name="IKUTK-0101-EM00200:D10_H_D-WIHA" onchange="update_value( event, '$DK_PUMP_TEXT' )"></div>
        <div data-wica-channel-name="IKUTK-0101-EB00400:M02_A_D-WIHA" onchange="update_value( event, '$DK_LEITWERK_TEXT',  true )"></div>
        <div data-wica-channel-name="IKUTK-0101-EB00803:M02_A_D-WIHA" onchange="update_value( event, '$DK_TEMP_VOR_TEXT',  true )"></div>
        <div data-wica-channel-name="IKUTK-0101-EB00802:M02_A_D-WIHA" onchange="update_value( event, '$DK_TEMP_RUCK_TEXT', true )"></div>
    </div>

    <object id="svgObject" type="image/svg+xml" data="vacuum_panel.svg"> </object>

    <script>

        let svgDoc = null;

        function update_value( event, svgVar, optUnits = false )
        {
            if ( svgDoc === null ) {
                const svgElement = document.getElementById( "svgObject" );
                svgDoc = svgElement.contentDocument;
            }

            const myTarget = svgDoc.getElementById( svgVar );
            if ( myTarget == null ) {
                return;
            }

            const units = optUnits ? event.channelMetadata.egu : "";
            updateTextContent( myTarget, event.channelValueLatest.val + " " + units  );
        }

        function updateTextContent( svgElement, value )
        {
            svgElement.textContent = value;
        }


        function update_color( event, svgVar, okValue )
        {
            if ( svgDoc === null ) {
                const svgElement = document.getElementById( "svgObject" );
                svgDoc = svgElement.contentDocument;
            }

            const mySymbol = svgDoc.getElementById( svgVar );
            if ( mySymbol == null ) {
                return;
            }

            updateVisualState( mySymbol, event.channelValueLatest.val, okValue )
        }

        function updateVisualState( svgElement, value, okValue, nokValue )
        {
            const errColor ="orange";
            const nokColor = "red";
            const okColor = "limegreen";

            switch ( value )
            {
                case okValue:
                    svgElement.style.fill = okColor;
                    break;

                case nokValue:
                    svgElement.style.fill = nokColor;
                    break;

                default:
                    svgElement.style.fill = errColor;
                    break;
            }
        }

    </script>

</body>
</html>

